// Prisma Schema for Hatch Stock Management System
// Connected to Supabase project: Stock_tracker (tujgcuzqazxixaxrdpws)

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DATABASE_URL")
}

// ============ PRODUCTS ============

model Product {
  sku       String   @id
  name      String
  category  String?
  unitCost  Float?   @map("unit_cost")
  salePrice Float?   @map("sale_price")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  warehouseStock  WarehouseStock[]
  locationStock   LocationStock[]
  stockBatches    StockBatch[]
  orderItems      OrderItem[]
  sales           Sale[]
  locationConfigs LocationConfig[]

  @@map("products")
}

// ============ WAREHOUSES ============

model Warehouse {
  id        String   @id @default(uuid())
  name      String
  address   String?
  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  stock        WarehouseStock[]
  stockBatches StockBatch[]
  removals     StockRemoval[]

  @@map("warehouses")
}

model WarehouseStock {
  warehouseId String    @map("warehouse_id")
  sku         String
  quantity    Int       @default(0)
  updatedAt   DateTime  @updatedAt @map("updated_at")

  warehouse Warehouse @relation(fields: [warehouseId], references: [id], onDelete: Cascade)
  product   Product   @relation(fields: [sku], references: [sku], onDelete: Cascade)

  @@id([warehouseId, sku])
  @@map("warehouse_stock")
}

// ============ LOCATIONS ============

model Location {
  id        String   @id @default(uuid())
  name      String
  type      String   @default("vending") // vending, retail, storage
  address   String?
  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  stock         LocationStock[]
  configs       LocationConfig[]
  restocks      RestockRecord[]
  stockChecks   StockCheck[]
  assignedItems LocationAssignment[]

  @@map("locations")
}

model LocationStock {
  locationId String   @map("location_id")
  sku        String
  quantity   Int      @default(0)
  updatedAt  DateTime @updatedAt @map("updated_at")

  location Location @relation(fields: [locationId], references: [id], onDelete: Cascade)
  product  Product  @relation(fields: [sku], references: [sku], onDelete: Cascade)

  @@id([locationId, sku])
  @@map("location_stock")
}

model LocationConfig {
  locationId String @map("location_id")
  sku        String
  minStock   Int?   @map("min_stock")
  maxStock   Int?   @map("max_stock")

  location Location @relation(fields: [locationId], references: [id], onDelete: Cascade)
  product  Product  @relation(fields: [sku], references: [sku], onDelete: Cascade)

  @@id([locationId, sku])
  @@map("location_config")
}

model LocationAssignment {
  locationId String @map("location_id")
  sku        String

  location Location @relation(fields: [locationId], references: [id], onDelete: Cascade)

  @@id([locationId, sku])
  @@map("location_assignments")
}

// ============ STOCK BATCHES (Expiry Tracking) ============

model StockBatch {
  id           String    @id @default(uuid())
  warehouseId  String    @map("warehouse_id")
  sku          String
  quantity     Int
  remainingQty Int       @map("remaining_qty")
  expiryDate   DateTime? @map("expiry_date")
  hasDamage    Boolean   @default(false) @map("has_damage")
  damageNotes  String?   @map("damage_notes")
  receivedAt   DateTime  @default(now()) @map("received_at")

  warehouse Warehouse @relation(fields: [warehouseId], references: [id], onDelete: Cascade)
  product   Product   @relation(fields: [sku], references: [sku], onDelete: Cascade)

  @@map("stock_batches")
}

// ============ SUPPLIERS ============

model Supplier {
  id        String   @id @default(uuid())
  name      String
  contact   String?
  email     String?
  phone     String?
  address   String?
  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  orders Order[]

  @@map("suppliers")
}

// ============ ORDERS ============

model Order {
  id             String    @id @default(uuid())
  supplierId     String?   @map("supplier_id")
  status         String    @default("pending") // pending, received, cancelled
  deliveryMethod String?   @map("delivery_method")
  deliveryTo     String?   @map("delivery_to")
  deliveryFee    Float?    @map("delivery_fee")
  notes          String?
  invoiceRef     String?   @map("invoice_ref")
  totalAmount    Float?    @map("total_amount")
  createdAt      DateTime  @default(now()) @map("created_at")
  receivedAt     DateTime? @map("received_at")

  supplier Supplier?   @relation(fields: [supplierId], references: [id])
  items    OrderItem[]

  @@map("orders")
}

model OrderItem {
  id        String @id @default(uuid())
  orderId   String @map("order_id")
  sku       String
  quantity  Int
  unitPrice Float? @map("unit_price")

  order   Order   @relation(fields: [orderId], references: [id], onDelete: Cascade)
  product Product @relation(fields: [sku], references: [sku])

  @@map("order_items")
}

// ============ STOCK MOVEMENTS ============

model StockRemoval {
  id          String   @id @default(uuid())
  warehouseId String   @map("warehouse_id")
  routeId     String?  @map("route_id")
  routeName   String?  @map("route_name")
  takenBy     String?  @map("taken_by")
  notes       String?
  items       Json     // [{ sku, quantity }]
  createdAt   DateTime @default(now()) @map("created_at")

  warehouse Warehouse @relation(fields: [warehouseId], references: [id])

  @@map("stock_removals")
}

model RestockRecord {
  id          String   @id @default(uuid())
  locationId  String   @map("location_id")
  performedBy String?  @map("performed_by")
  items       Json     // [{ sku, quantity }]
  photoUrl    String?  @map("photo_url")
  notes       String?
  createdAt   DateTime @default(now()) @map("created_at")

  location Location @relation(fields: [locationId], references: [id])

  @@map("restock_records")
}

model StockCheck {
  id          String   @id @default(uuid())
  locationId  String   @map("location_id")
  performedBy String?  @map("performed_by")
  items       Json     // [{ sku, expected, counted, variance }]
  createdAt   DateTime @default(now()) @map("created_at")

  location Location @relation(fields: [locationId], references: [id])

  @@map("stock_checks")
}

// ============ RESTOCK ROUTES ============

model RestockRoute {
  id          String   @id @default(uuid())
  name        String
  locationIds Json     @map("location_ids") // Array of location IDs in order
  createdAt   DateTime @default(now()) @map("created_at")

  @@map("restock_routes")
}

// ============ SALES ============

model Sale {
  id            String   @id // Transaction ID from source system
  sku           String
  productName   String?  @map("product_name")
  quantity      Int      @default(1)
  charged       Float
  costPrice     Float?   @map("cost_price")
  paymentMethod String?  @map("payment_method")
  locationName  String?  @map("location_name")
  machineName   String?  @map("machine_name")
  timestamp     DateTime
  importedAt    DateTime @default(now()) @map("imported_at")

  product Product? @relation(fields: [sku], references: [sku])

  @@map("sales")
}

model SalesImport {
  id           String   @id @default(uuid())
  filename     String
  recordsAdded Int      @map("records_added")
  recordsTotal Int      @map("records_total")
  importedAt   DateTime @default(now()) @map("imported_at")

  @@map("sales_imports")
}

// ============ USERS (Optional Auth) ============

model User {
  id        String   @id @default(uuid())
  email     String   @unique
  password  String
  name      String?
  role      String   @default("user") // admin, user
  createdAt DateTime @default(now()) @map("created_at")

  @@map("users")
}
